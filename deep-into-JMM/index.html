<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">















  
  
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css">







<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon32.ico?v=7.1.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon16.ico?v=7.1.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.1.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":true,"dimmer":false},
    back2top: true,
    back2top_sidebar: true,
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="转载自 https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM)%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/  分享目标本文通过Java volatile探讨以下问题  Volatil">
<meta name="keywords" content="并发">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解Java内存模型(JMM)及Volatile关键字（转载）">
<meta property="og:url" content="http://keanu96.github.io/deep-into-JMM/index.html">
<meta property="og:site_name" content="Keanu">
<meta property="og:description" content="转载自 https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM)%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/  分享目标本文通过Java volatile探讨以下问题  Volatil">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://keanu96.github.io/deep-into-JMM/13.png">
<meta property="og:image" content="http://keanu96.github.io/deep-into-JMM/14.png">
<meta property="og:image" content="http://keanu96.github.io/deep-into-JMM/1.png">
<meta property="og:image" content="http://keanu96.github.io/deep-into-JMM/2.png">
<meta property="og:image" content="http://keanu96.github.io/deep-in-JMM/3.png">
<meta property="og:image" content="http://keanu96.github.io/deep-into-JMM/4.png">
<meta property="og:image" content="http://keanu96.github.io/deep-into-JMM/12.png">
<meta property="og:image" content="http://keanu96.github.io/deep-into-JMM/5.png">
<meta property="og:image" content="http://keanu96.github.io/deep-into-JMM/6.png">
<meta property="og:image" content="http://keanu96.github.io/deep-into-JMM/7.png">
<meta property="og:image" content="http://keanu96.github.io/deep-into-JMM/8.png">
<meta property="og:image" content="http://keanu96.github.io/deep-into-JMM/9.png">
<meta property="og:image" content="http://keanu96.github.io/deep-into-JMM/10.png">
<meta property="og:image" content="http://keanu96.github.io/deep-into-JMM/11.png">
<meta property="og:updated_time" content="2019-10-30T13:16:21.207Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入理解Java内存模型(JMM)及Volatile关键字（转载）">
<meta name="twitter:description" content="转载自 https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM)%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/  分享目标本文通过Java volatile探讨以下问题  Volatil">
<meta name="twitter:image" content="http://keanu96.github.io/deep-into-JMM/13.png">



  <link rel="alternate" href="/atom.xml" title="Keanu" type="application/atom+xml">



  
  
  <link rel="canonical" href="http://keanu96.github.io/deep-into-JMM/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>深入理解Java内存模型(JMM)及Volatile关键字（转载） | Keanu</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Keanu</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">Don't be mediocre!</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">

    
    
    
      
    

    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>站点地图</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/keanu96" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://keanu96.github.io/deep-into-JMM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Keanu">
      <meta itemprop="description" content="Keanu 的技术小记">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Keanu">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">深入理解Java内存模型(JMM)及Volatile关键字（转载）

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-10-28 22:45:52" itemprop="dateCreated datePublished" datetime="2019-10-28T22:45:52+08:00">2019-10-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-10-30 21:16:21" itemprop="dateModified" datetime="2019-10-30T21:16:21+08:00">2019-10-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/deep-into-JMM/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="deep-into-JMM/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">14k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">12 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>转载自 <a href="https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM)%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/" target="_blank" rel="noopener">https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM)%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/</a></p>
</blockquote>
<h2 id="分享目标"><a href="#分享目标" class="headerlink" title="分享目标"></a>分享目标</h2><p>本文通过Java volatile探讨以下问题</p>
<ul>
<li>Volatile多线程引发的缓存一致性问题</li>
<li>Volatile多线程引发的不可见问题</li>
<li>Volatile多线程引发的原子性问题</li>
<li>指令重排序含义及相关语义和规则</li>
<li>内存屏障的分类和使用</li>
<li>源码跟踪</li>
</ul>
<a id="more"></a>
<h4 id="1-1-多线程之间通信机制"><a href="#1-1-多线程之间通信机制" class="headerlink" title="1.1 多线程之间通信机制"></a>1.1 多线程之间通信机制</h4><p>线程之间的通信机制有两种：<strong>共享内存</strong>和<strong>消息传递</strong>,Java的并发采用的是共享内存模型机制。</p>
<p><img src="13.png" alt="共享内存通信"></p>
<p><img src="14.png" alt="线程间通信"></p>
<h4 id="1-2-原子性操作"><a href="#1-2-原子性操作" class="headerlink" title="1.2 原子性操作"></a>1.2 原子性操作</h4><p>在探讨问题之前需要先了解一下JMM的内存模型提供的八大原子性操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">read(读取): 从主内存读取数据</span><br><span class="line">load(载入): 将主内存读取到的数据写入工作内存中</span><br><span class="line">use(使用): 从工作内存读取数据来计算</span><br><span class="line">assign(赋值): 将计算好的值重新赋值到工作内存中</span><br><span class="line">store(存储): 将工作内存数据写入主内存读写缓冲(loadStoreBuffer)</span><br><span class="line">write(写入): 将读写缓冲的变量赋值给主内存中的变量</span><br><span class="line">lock(锁定): 将读写缓冲中共享变量加锁,标识为线程独占状态</span><br><span class="line">unlock(解锁): 将读写缓冲中共享变量解锁,解锁后其他线程可以锁定该变量</span><br></pre></td></tr></table></figure>
<h4 id="1-3-MESI缓存行"><a href="#1-3-MESI缓存行" class="headerlink" title="1.3 MESI缓存行"></a>1.3 MESI缓存行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MESI协议是以缓存行(缓存的基本数据单位，在Intel的CPU上一般是64字节)的几个状态来命名的(全名是Modified、Exclusive、 Share or Invalid)。该协议要求在每个缓存行上维护两个状态位，使得每个数据单位可能处于M、E、S和I这四种状态之一，各种状态含义如下：</span><br><span class="line">M：所有CPU把缓存状态改为I之后，会向主内存同步数据</span><br><span class="line">E：独占的。处于这一状态的数据，只有在本CPU中有缓存，且其数据没有修改，即与内存中一致</span><br><span class="line">S：共享的。处于这一状态的数据在多个CPU中都有缓存，且与内存一致</span><br><span class="line">I：无效的。本CPU中的这份缓存已经无效</span><br></pre></td></tr></table></figure>
<h4 id="1-4-Javap命令详解"><a href="#1-4-Javap命令详解" class="headerlink" title="1.4 Javap命令详解"></a>1.4 Javap命令详解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">用法: javap &lt;options&gt; &lt;classes&gt;</span><br><span class="line">其中, 可能的选项包括:</span><br><span class="line">  -help  --help  -?        输出此用法消息</span><br><span class="line">  -version                 版本信息</span><br><span class="line">  -v  -verbose             输出附加信息</span><br><span class="line">  -l                       输出行号和本地变量表</span><br><span class="line">  -public                  仅显示公共类和成员</span><br><span class="line">  -protected               显示受保护的/公共类和成员</span><br><span class="line">  -package                 显示程序包/受保护的/公共类</span><br><span class="line">                           和成员 (默认)</span><br><span class="line">  -p  -private             显示所有类和成员</span><br><span class="line">  -c                       对代码进行反汇编</span><br><span class="line">  -s                       输出内部类型签名</span><br><span class="line">  -sysinfo                 显示正在处理的类的</span><br><span class="line">                           系统信息 (路径, 大小, 日期, MD5 散列)</span><br><span class="line">  -constants               显示最终常量</span><br><span class="line">  -classpath &lt;path&gt;        指定查找用户类文件的位置</span><br><span class="line">  -cp &lt;path&gt;               指定查找用户类文件的位置</span><br><span class="line">  -bootclasspath &lt;path&gt;    覆盖引导类文件的位置</span><br></pre></td></tr></table></figure>
<h3 id="2、多线程下共享变量引发问题"><a href="#2、多线程下共享变量引发问题" class="headerlink" title="2、多线程下共享变量引发问题"></a>2、多线程下共享变量引发问题</h3><h4 id="2-1-缓存不一致及不可见问题"><a href="#2-1-缓存不一致及不可见问题" class="headerlink" title="2.1 缓存不一致及不可见问题"></a>2.1 缓存不一致及不可见问题</h4><p>多线程情况下未添加volatile关键字修饰导致出现死循环：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public class VolatileTest &#123;</span><br><span class="line"></span><br><span class="line">    private static boolean initFlag = false;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        new Thread(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                System.out.println(&quot;waiting data...&quot;);</span><br><span class="line">                while (!initFlag) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(&quot;success...&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(2000);</span><br><span class="line"></span><br><span class="line">        new Thread(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                prepareData();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void prepareData() &#123;</span><br><span class="line">        System.out.println(&quot;prepareData...&quot;);</span><br><span class="line">        initFlag = true;</span><br><span class="line">        System.out.println(&quot;prepare commit...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">运行结果：</span><br><span class="line">waiting data...</span><br><span class="line">prepareData...</span><br><span class="line">prepare commit...</span><br></pre></td></tr></table></figure>
<p>线程一永远处理阻塞状态，无法获取到线程2修改后的最新数据；</p>
<p>上述代码的交互流程：</p>
<p><img src="1.png" alt="线程不可见"></p>
<p>T1和T2同时从主内存加载initFlag = false，各自进行代码执行。T二修改initFlag为true并写入主内存；而T1并不知晓，initFlag变量是属于有效状态一直处于false，代码处于while中一直无法跳出，导致死循环。</p>
<h4 id="2-2-原子性问题"><a href="#2-2-原子性问题" class="headerlink" title="2.2 原子性问题"></a>2.2 原子性问题</h4><p>volatile关键字并不能保证原子性，利用volatile来修饰Increment的变量是一种错误的写法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class AtomicDemo implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">    private volatile static int count = 0;</span><br><span class="line"></span><br><span class="line">    private static ExecutorService executor = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        for (int i = 0; i &lt; 1000; i++) &#123;</span><br><span class="line">            executor.submit(new AtomicDemo());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(&quot;count累加运行结果：&quot; + count);</span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">count累加运行结果：967</span><br><span class="line">count累加运行结果：958</span><br></pre></td></tr></table></figure>
<p>上述代码运行结果永远是小于等于1000，那么为什么不是每次都是1000呢？</p>
<h5 id="2-2-1-内存原子操作流程"><a href="#2-2-1-内存原子操作流程" class="headerlink" title="2.2.1 内存原子操作流程"></a>2.2.1 内存原子操作流程</h5><p>通过内存原子操作演练一下count++的流程：</p>
<p><img src="2.png" alt="原子性问题"></p>
<p>T1T2线程同时读取(read)和加载(load)count=0到各自的工作内存，然后复制给执行引擎进行Increment计算，T2 Increment后assign count=1回到工作内存，这时候T1也是同样的操作，当然这时候T1也可以还在执行引擎计算未执行assign操作。这时候T2需要把修改后的数据(storeBuffer)强制写回主内存（StoreLoad屏障），在这之前需要进行lock操作锁定主内存(绿色)count变量，当回写操作通过总线MESI缓存一致性协议时，其他线程会通过CPU总线嗅探机制监听到，各自把各自工作内存中的count变量状态设置为失效状态。那么这时候T1可能已经是Increment后的值count=1,那么T1再次计算count累加时需要重新从主内存再次读取和加载，获取到count=1。实际上T1和T2已经对count进行了2次Increment按道理来说这时候count的值为2，而其他线程这时候拿到的却是1，导致count累加值丢失。</p>
<p>由上图可以看出count++并非单个原子性操作，它需要先read-&gt;load-&gt;use-&gt;assign-&gt;store-&gt;write操作才能完成整个操作，虽然上述单个操作都是原子性操作，但是组合起来就是非原子性了。</p>
<h5 id="2-2-2-字节码跟踪流程"><a href="#2-2-2-字节码跟踪流程" class="headerlink" title="2.2.2 字节码跟踪流程"></a>2.2.2 字节码跟踪流程</h5><p>为了演示，我们尽可能使用少量代码，通过javap -v -p 命令对class文件进行字节码展示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class VolatileTest &#123;</span><br><span class="line"></span><br><span class="line">    volatile int i = 1;</span><br><span class="line"></span><br><span class="line">    public void inc()&#123;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        new VolatileTest().inc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反汇编后的字节码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public class com.example.demo.VolatileTest</span><br><span class="line">&#123;</span><br><span class="line">  volatile int i;</span><br><span class="line">    descriptor: I</span><br><span class="line">    flags: ACC_VOLATILE //volatile i 添加ACC_VOLATILE修饰符</span><br><span class="line"></span><br><span class="line">  public com.example.demo.VolatileTest();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC </span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: aload_0</span><br><span class="line">         5: iconst_1</span><br><span class="line">         6: putfield      #2                  // Field i:I</span><br><span class="line">         9: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 8: 0</span><br><span class="line">        line 10: 4</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0      10     0  this   Lcom/example/demo/VolatileTest;</span><br><span class="line">            </span><br><span class="line">  public void inc();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC //方法访问修饰符</span><br><span class="line">    Code:</span><br><span class="line">      stack=3, locals=1, args_size=1</span><br><span class="line">         0: aload_0 //取this对应的对应引用值，压入操作数栈,也就是VolatileTest的实例，即getfield的主体</span><br><span class="line">         1: dup //复制栈顶数值，并压入栈顶,此时栈中有两个值，都是this对象引用</span><br><span class="line">         2: getfield      #2                  // Field i:I //获取对象i字段，将其值压入栈顶</span><br><span class="line">         5: iconst_1 //int型常量1进栈</span><br><span class="line">         6: iadd //弹出栈中的i值和常量1，进行加操作，并将结果压入栈</span><br><span class="line">         7: putfield      #2                  // Field i:I //赋值对象i字段 i=1</span><br><span class="line">        10: return //return void</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 13: 0</span><br><span class="line">        line 14: 10</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0      11     0  this   Lcom/example/demo/VolatileTest;//看这里</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>字节码中inc方法中第2、6、7分别3步操作getfield-&gt;iadd-&gt;putfield，这就是同学们说的i++并不是单个原子性操作，多线程情况下getfield并不能保证获取到最新值，造成数据操作丢失，出现原子性问题。</p>
<h3 id="3、-解决方案"><a href="#3、-解决方案" class="headerlink" title="3、 解决方案"></a>3、 解决方案</h3><ul>
<li>总线加锁</li>
<li>共享变量加锁</li>
</ul>
<h4 id="3-1-总线加锁机制（性能太低）"><a href="#3-1-总线加锁机制（性能太低）" class="headerlink" title="3.1 总线加锁机制（性能太低）"></a>3.1 总线加锁机制（性能太低）</h4><p>最早期的X86解决方案是使用总线加锁机制来实现共享变量数据一致性问题。从主内存读取数据到高速缓存，会在总线对这个数据进行加锁，这样其他CPU没法去读或者写这个数据，直到锁释放后才能给其他CPU操作数据，这个机制虽然解决了数据一致性问题，但是对多核CPU来说由原来的并行执行改为串行执行，性能非常的低下；</p>
<p><img src="/deep-in-JMM/3.png" alt="总线加锁"></p>
<h4 id="3-2-MESI缓存一致性协议"><a href="#3-2-MESI缓存一致性协议" class="headerlink" title="3.2 MESI缓存一致性协议"></a>3.2 MESI缓存一致性协议</h4><p>多个CPU从主内存读取共享数据到各自的高速缓存，当其中某个CPU修改了缓存里的数据，该数据会马上同步回主内存，其他CPU通过总线<strong>嗅探机制</strong>可以感知到数据的变化从而将自己缓存里的数据设置<strong>失效</strong>，当线程处理存储操作时会在store前调用lock操作，数据write主内存后进行unLock操作。如果多个线程都来修改共享变量就会进行锁竞争；</p>
<p><img src="4.png" alt="MESI缓存一致性协议"></p>
<h3 id="4、指令重排序"><a href="#4、指令重排序" class="headerlink" title="4、指令重排序"></a>4、指令重排序</h3><p>重排序是指编译器和处理器为了优化程序性能而对指令序列进行重新排序的一种手段。重排序分为两类：<strong>编译期重排序</strong>和<strong>运行期重排序</strong>，分别对应编译时和运行时环境。</p>
<ul>
<li>编译期重排序的典型就是通过调整指令顺序，在单线程下不改变程序语义的前提下，尽可能减少寄存器的读取、存储次数，充分复用寄存器的存储值。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">假设第一条指令计算一个值赋给变量A并存放在寄存器中，第二条指令与A无关但需要占用寄存器（假设它将占用A所在的那个寄存器），第三条指令使用A的值且与第二条指令无关。那么如果按照顺序一致性模型，A在第一条指令执行过后被放入寄存器，在第二条指令执行时A不再存在，第三条指令执行时A重新被读入寄存器，而这个过程中，A的值没有发生变化。通常编译器都会交换第二和第三条指令的位置，这样第一条指令结束时A存在于寄存器中，接下来可以直接从寄存器中读取A的值，降低了重复读取的开销。</span><br></pre></td></tr></table></figure>
<ul>
<li>运行期重排序包含指令并行的重排和内存系统的重排<ul>
<li>指令并行重排序是通过处理器采用了指令级并行技术来将多条指令重叠执行。需要建立在数据不存在依赖性时处理器可以改变语句对应的机器指令的执行顺序的情况下</li>
<li>内存系统重排序是指处理器使用缓存和读写缓冲区，这使得加载(load)和存储(store)操作看上去可能是在乱序执行</li>
</ul>
</li>
</ul>
<p>从 java 源代码到最终实际执行的指令序列，会分别经历下面三种重排序：</p>
<p><img src="12.png" alt="指令重排序"></p>
<h4 id="4-1-数据依赖性"><a href="#4-1-数据依赖性" class="headerlink" title="4.1 数据依赖性"></a>4.1 数据依赖性</h4><p>如果两个操作访问同一个变量，且这两个操作中有一个为写操作，此时这两个操作之间就存在数据依赖性。数据依赖分为下列3种类型：</p>
<table>
<thead>
<tr>
<th style="text-align:left">名称</th>
<th style="text-align:left">代码示例</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">写后读</td>
<td style="text-align:left">a=1;b=a;</td>
<td style="text-align:left">写一个变量后，再读这个变量</td>
</tr>
<tr>
<td style="text-align:left">写后写</td>
<td style="text-align:left">a=1;a=2;</td>
<td style="text-align:left">写一个变量后，再写这个变量</td>
</tr>
<tr>
<td style="text-align:left">读后写</td>
<td style="text-align:left">a=b;b=1;</td>
<td style="text-align:left">读一个变量后，再写这个变量</td>
</tr>
</tbody>
</table>
<p>上面3种情况，只要重排序两个操作的执行顺序，程序的执行结果就会被改变。前面提到过，编译器和处理器可能会对操作做重排序。编译器和处理器在重排序时，会遵守数据依赖性，编译器和处理器不会改变存在数据依赖关系的两个操作的执行顺序。这里所说的数据依赖性仅针对单个处理器中执行的指令序列和单个线程中执行的操作，不同处理器之间和不同线程之间的数据依赖性不被编译器和处理器考虑。</p>
<h4 id="4-2-as-if-serial语义"><a href="#4-2-as-if-serial语义" class="headerlink" title="4.2 as-if-serial语义"></a>4.2 as-if-serial语义</h4><p>as-if-serial语义的意思是：不管怎么重排序程序的执行结果不能被改变(<strong>单线程</strong>)。编译器、runtime和处理器都必须遵守as-if-serial语义。为了遵守as-if-serial语义，编译器和处理器不会对存在<strong>数据依赖关系</strong>的操作做重排序，因<br>为这种重排序会改变执行结果。但是，如果操作之间不存在数据依赖关系，这些操作就可能被编译器和处理器重排序。代码示例，计算圆的面积：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">double pi = 3.14; // A</span><br><span class="line">double r = 1.0; // B</span><br><span class="line">double area = pi * r * r; // C</span><br></pre></td></tr></table></figure>
<p>代码C依赖A和B,代码依赖操作流程：</p>
<p><img src="5.png" alt="img"></p>
<p>A和B之间没有数据依赖关系，编译器和处理器可以重排序A和B之间的执行顺序。该程序的两种执行顺序如下：</p>
<p><img src="6.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">area = 3.14</span><br></pre></td></tr></table></figure>
<p><img src="7.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">area = 3.14</span><br></pre></td></tr></table></figure>
<p>编译器和处理器重排序后，不仅优化了编译指令还能保证最终执行结果也一致。</p>
<p>as-if-serial语义把<strong>单线程</strong>程序保护了起来，遵守as-if-serial语义的编译器、runtime和处理器共同为编写单线程程序的程序员创建了一个幻觉：单线程程序是按程序的顺序来执行的。asif-serial语义使单线程程序员无需担心重排序会干扰他们，也无需担心内存可见性问题。</p>
<h4 id="4-3-happens-before规则"><a href="#4-3-happens-before规则" class="headerlink" title="4.3 happens-before规则"></a>4.3 happens-before规则</h4><p>根据happens-before的程序顺序规则，上面计算圆的面积的示例代码存在3个happensbefore关系。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A　happens-before B</span><br><span class="line">B　happens-before C</span><br><span class="line">A　happens-before C</span><br></pre></td></tr></table></figure>
<p>这里的第3个happens-before关系，是根据happens-before的传递性推导出来的。</p>
<p>这里A happens-before B，但实际执行时B却可以排在A之前执行（看上面的重排序后的执行顺序）。如果A happens-before B，JMM并不要求A一定要在B之前执行。JMM仅仅要求前一个操作（执行的结果）对后一个操作可见(A和B对C可见)，且前一个操作按顺序排在第二个操作之前（A和B排在C之前）。</p>
<p>这里操作A的执行结果不需要对操作B可见；而且重排序操作A和操作B后的执行结果，与操作A和操作B按happens-before顺序执行的结果一致。在这种情况下，JMM会认为这种重排序并不非法（not illegal），JMM允许这种重排序。</p>
<p>在计算机中，软件技术和硬件技术有一个共同的目标：在不改变程序执行结果的前提下，尽可能提高并行度。编译器和处理器遵从这一目标，从happens-before的定义我们可以看出，JMM同样遵从这一目标。</p>
<h4 id="4-4-顺序一致性"><a href="#4-4-顺序一致性" class="headerlink" title="4.4 顺序一致性"></a>4.4 顺序一致性</h4><p>顺序一致性内存模型是一个理论参考模型，在设计的时候，处理器的内存模型和编程语言的内存模型都会以顺序一致性内存模型作为参照。尽管最终执行指令在执行时并不一定按照我们所编写的顺序执行，但毋庸置疑的是，<strong>在单线程环境下，指令执行的最终效果应当与其在顺序执行下的效果一致</strong>，否则这种优化便会失去意义。</p>
<p>通常无论是在编译期还是运行期进行的指令重排序，都会满足上面的原则。</p>
<h3 id="5、内存屏障"><a href="#5、内存屏障" class="headerlink" title="5、内存屏障"></a>5、内存屏障</h3><h4 id="5-1-什么是内存屏障？"><a href="#5-1-什么是内存屏障？" class="headerlink" title="5.1 什么是内存屏障？"></a>5.1 什么是内存屏障？</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A memory barrier, also known as a membar, memory fence or fence instruction, is a type of barrier instruction that causes a CPU or compiler to enforce an ordering constraint on memory operations issued before and after the barrier instruction. This typically means that operations issued prior to the barrier are guaranteed to be performed before operations issued after the barrier.</span><br><span class="line"></span><br><span class="line">内存屏障，也称内存栅栏，内存栅障，屏障指令等， 是一类同步屏障指令，是CPU或编译器在对内存随机访问的操作中的一个同步点，使得此点之前的所有读写操作都执行后才可以开始执行此点之后的操作。</span><br></pre></td></tr></table></figure>
<h4 id="5-2-内存屏障和happens-before是什么关系？"><a href="#5-2-内存屏障和happens-before是什么关系？" class="headerlink" title="5.2 内存屏障和happens-before是什么关系？"></a>5.2 内存屏障和happens-before是什么关系？</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">happens-before是JSR-133规范之一，内存屏障是CPU指令。可以理解前者是最终目的，后者是实现手段。</span><br></pre></td></tr></table></figure>
<h4 id="5-3-内存屏障分类"><a href="#5-3-内存屏障分类" class="headerlink" title="5.3 内存屏障分类"></a>5.3 内存屏障分类</h4><p>内存屏障分为<strong>Store屏障</strong>和<strong>Load屏障</strong>两大类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">基于保守策略的JMM内存屏障插入策略(绿色操作标志)：</span><br><span class="line">在每个volatile写操作的前面插入一个StoreStore屏障</span><br><span class="line">在每个volatile写操作的后面插入一个StoreLoad屏障</span><br><span class="line">在每个volatile读操作的后面插入一个LoadLoad屏障</span><br><span class="line">在每个volatile读操作的后面插入一个LoadStore屏障</span><br><span class="line">上述内存屏障插入策略非常保守，但它可以保证在任意处理器平台，任意的程序中都能得到正确的volatile内存语义,在实际执行时，只要不改变volatile写-读的内存语义，编译器可以根据具体情况省略不必要的屏障。</span><br></pre></td></tr></table></figure>
<h5 id="5-3-1-LoadLoad屏障"><a href="#5-3-1-LoadLoad屏障" class="headerlink" title="5.3.1 LoadLoad屏障"></a>5.3.1 LoadLoad屏障</h5><p>抽象场景：Load1; LoadLoad; Load2</p>
<p>Load1 和 Load2 代表两条读取指令。Load2读取数据被访问（use）前，要保证Load1读取的数据被读取完毕。</p>
<p><img src="8.png" alt="LoadLoad"></p>
<h5 id="5-3-2-StoreStore屏障"><a href="#5-3-2-StoreStore屏障" class="headerlink" title="5.3.2 StoreStore屏障"></a>5.3.2 StoreStore屏障</h5><p>抽象场景：Store1; StoreStore; Store2</p>
<p>Store1 和 Store2代表两条写入指令。Store2写入（store）执行前，要保证Store1的写入操作对其它处理器可见。</p>
<p><img src="9.png" alt="StoreStore"></p>
<h5 id="5-3-3-LoadStore屏障"><a href="#5-3-3-LoadStore屏障" class="headerlink" title="5.3.3 LoadStore屏障"></a>5.3.3 LoadStore屏障</h5><p>抽象场景：Load1; LoadStore; Store2</p>
<p>Load1代表读取指令，Store2代表写入指令。Store2被写入（store）执行前，要保证Load1读取的数据被读取完毕。</p>
<p><img src="10.png" alt="LoadStore"></p>
<h5 id="5-3-4-StoreLoad屏障"><a href="#5-3-4-StoreLoad屏障" class="headerlink" title="5.3.4 StoreLoad屏障"></a>5.3.4 StoreLoad屏障</h5><p>抽象场景：Store1; StoreLoad; Load2</p>
<p>Store1代表写入指令，Load2代表读取指令。Load2读取操作（read）执行前，要保证Store1的写入对所有处理器可见。StoreLoad屏障的开销是四种屏障中最大的。</p>
<p><img src="11.png" alt="StoreLoad"></p>
<h3 id="6、源码跟踪"><a href="#6、源码跟踪" class="headerlink" title="6、源码跟踪"></a>6、源码跟踪</h3><p>在2.2.2 字节码流程基础上进行hotspot源码跟踪，被volatile修饰的字段会多一个 <strong>ACC_VOLATILE</strong>的flag，在给字段赋值的时候通过<code>BytecodeInterpreter</code>解释器来执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">##src/share/vm/interpreter/bytecodeInterpreter.cpp:1831</span><br><span class="line"></span><br><span class="line">CASE(_putstatic):</span><br><span class="line">        &#123;</span><br><span class="line">          u2 index = Bytes::get_native_u2(pc+1);</span><br><span class="line">          ConstantPoolCacheEntry* cache = cp-&gt;entry_at(index);</span><br><span class="line">          if (!cache-&gt;is_resolved((Bytecodes::Code)opcode)) &#123;</span><br><span class="line">            CALL_VM(InterpreterRuntime::resolve_get_put(THREAD, (Bytecodes::Code)opcode),</span><br><span class="line">                    handle_exception);</span><br><span class="line">            cache = cp-&gt;entry_at(index);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">#ifdef VM_JVMTI</span><br><span class="line">          if (_jvmti_interp_events) &#123;</span><br><span class="line">           //代码省略</span><br><span class="line">          &#125;</span><br><span class="line">#endif /* VM_JVMTI */</span><br><span class="line">          //判断i是否被volatile修饰</span><br><span class="line">          if (cache-&gt;is_volatile()) &#123;</span><br><span class="line">            if (tos_type == itos) &#123;</span><br><span class="line">                //整形字段修改</span><br><span class="line">              obj-&gt;release_int_field_put(field_offset, STACK_INT(-1));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">              //代码省略</span><br><span class="line">            &#125;</span><br><span class="line">            OrderAccess::storeload();//赋值完成后插入storeload内存屏障，禁止上面的volatile写和下面的volatile读写重排序</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            //非volatile修饰处理 代码省略</span><br><span class="line">          &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>首先我们关注cache-&gt;is_volatile()这段代码，cache是<strong>i</strong>在常量池缓存中的一个实例，这段代码是校验cache是否是被 volatile修饰，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">##src/share/vm/utilities/accessFlags.hpp:103</span><br><span class="line">public:</span><br><span class="line">  // Java access flags</span><br><span class="line">  // ..代码省略</span><br><span class="line">  bool is_volatile    () const         &#123; return (_flags &amp; JVM_ACC_VOLATILE    ) != 0; &#125;</span><br></pre></td></tr></table></figure>
<p>is_volatile是判断是否有 ACC_VOLATILE的flag标志，很显然变量<strong>i</strong>是符合这个条件的，所以结果必然返回true。接着，根据当前字段的类型来给<strong>i</strong>赋值，执行 release_int_field_put方法赋值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">##src/share/vm/oops/oop.inline.hpp:384</span><br><span class="line">inline void oopDesc::release_int_field_put(int offset, jint contents)</span><br><span class="line">&#123; OrderAccess::release_store(int_field_addr(offset), contents);  &#125;</span><br></pre></td></tr></table></figure>
<p>赋值的动作被包装了一层，看看 OrderAccess::release_store做了什么事情呢？找到 OrderAccess::release_store的实现，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">##src/os_cpu/linux_x86/vm/orderAccess_linux_x86.inline.hpp:82</span><br><span class="line">inline void OrderAccess::release_store(volatile jbyte*   p, jbyte   v) &#123; *p = v; &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到其实Java的volatile操作，在JVM实现层面第一步是给予了C++的原语实现。c/c++中的volatile关键字，用来修饰变量，通常用于语言级别的 memory barrier。被volatile声明的变量表示随时可能发生变化，每次使用时，都必须从变量<strong>i</strong>对应的内存地址读取，编译器对操作该变量的代码不再进行优化。</p>
<p>赋值操作完成以后，我们会发现还会执行一个 OrderAccess::storeload();的代码，它其实就是一个storeload内存屏障，JVM层面的四种内存屏障的定义以及实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">##src/os_cpu/linux_x86/vm/orderAccess_linux_x86.inline.hpp:34</span><br><span class="line">inline void OrderAccess::loadload()   &#123; acquire(); &#125;</span><br><span class="line">inline void OrderAccess::storestore() &#123; release(); &#125;</span><br><span class="line">inline void OrderAccess::loadstore()  &#123; acquire(); &#125;</span><br><span class="line">inline void OrderAccess::storeload()  &#123; fence(); &#125;</span><br><span class="line"></span><br><span class="line">##当调用storeload屏障时，它会调用fence()方法</span><br><span class="line">inline void OrderAccess::fence() &#123;</span><br><span class="line">  if (os::is_MP()) &#123;//返回是否多处理器,如果是多处理器才有必要增加内存屏障</span><br><span class="line">    // always use locked addl since mfence is sometimes expensive</span><br><span class="line">#ifdef AMD64</span><br><span class="line">    //__asm__ volatile 嵌入汇编指令</span><br><span class="line">    //lock 汇编指令,lock指令会锁住操作的缓存行,也就是缓存锁的实现</span><br><span class="line">    __asm__ volatile (&quot;lock; addl $0,0(%%rsp)&quot; : : : &quot;cc&quot;, &quot;memory&quot;);</span><br><span class="line">#else</span><br><span class="line">    __asm__ volatile (&quot;lock; addl $0,0(%%esp)&quot; : : : &quot;cc&quot;, &quot;memory&quot;);</span><br><span class="line">#endif</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>os::is_MP:判断是否是多核,如果是单核,那么就不存在内存不可见或者乱序的问题，<strong>volatile</strong>:禁止编译器对代码进行某些优化。<br>Lock :汇编指令，lock指令会锁住操作的缓存行(cacheline), 一般用于read-Modify-write的操作;用来保证后续的操作是原子的<br>cc：代表的是寄存器</p>
<p>memory：代表是内存</p>
<p>这边同时用了”cc”和”memory”,来通知编译器内存或者寄存器内的内容已经发生了修改,要重新生成加载指令(不可以从缓存寄存器中取),这边的read/write请求不能越过lock指令进行重排</p>
<h3 id="7、写在最后"><a href="#7、写在最后" class="headerlink" title="7、写在最后"></a>7、写在最后</h3><p>需要查看汇编指令的同学可以按照以下方式：</p>
<ul>
<li>获取到编译动态链接库文件,下载完毕后需要复制至${JAVA_HOME}/jre/bin/service目录下</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">##windows版本 hsdis-amd64.dll</span><br><span class="line">链接: https://pan.baidu.com/s/1pxrT0ny3csuCRNlPRvegIA 提取码: qr4k</span><br></pre></td></tr></table></figure>
<ul>
<li>测试类启动时configuration配置VM otions参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly VolatileTest(类名称) ##详细解释自行查阅</span><br></pre></td></tr></table></figure>
<p>hotspot源码下载地址:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/sccarterrans/hotspot</span><br></pre></td></tr></table></figure>
<p>[参考资料]</p>
<p><a href="http://ifeve.com/jvm-reordering/" target="_blank" rel="noopener">http://ifeve.com/jvm-reordering/</a></p>
<p><a href="https://juejin.im/entry/593e0ab25c497d006b93cfb1" target="_blank" rel="noopener">https://juejin.im/entry/593e0ab25c497d006b93cfb1</a></p>
<p><a href="http://gityuan.com/2015/10/24/jvm-bytecode-grammar/" target="_blank" rel="noopener">http://gityuan.com/2015/10/24/jvm-bytecode-grammar/</a></p>
<p><a href="https://my.oschina.net/tantexian/blog/808032" target="_blank" rel="noopener">https://my.oschina.net/tantexian/blog/808032</a></p>
<p><a href="https://www.520mwx.com/view/32394" target="_blank" rel="noopener">https://www.520mwx.com/view/32394</a></p>
<p>《Java并发编程的艺术》</p>

      
    </div>

    

    
    
    

    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

      
    </div>

    

    
      
    
    

    
      <div>
        




  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Keanu</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    
    <a href="http://keanu96.github.io/deep-into-JMM/" title="深入理解Java内存模型(JMM)及Volatile关键字（转载）">http://keanu96.github.io/deep-into-JMM/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/并发/" rel="tag"><i class="fa fa-tag"></i> 并发</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/volatile学习笔记/" rel="next" title="volatile学习笔记">
                <i class="fa fa-chevron-left"></i> volatile学习笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/deep-in-ribbon/" rel="prev" title="Ribbon 负载均衡源码分析">
                Ribbon 负载均衡源码分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="Keanu">
            
              <p class="site-author-name" itemprop="name">Keanu</p>
              <div class="site-description motion-element" itemprop="description">Keanu 的技术小记</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/rayyq" title="GitHub &rarr; https://github.com/rayyq" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:leiyongqi1026@gmail.com" title="E-Mail &rarr; mailto:leiyongqi1026@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://sccarterrans.github.io/" title="https://sccarterrans.github.io/" rel="noopener" target="_blank">辉</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://github.com/P1nov" title="https://github.com/P1nov" rel="noopener" target="_blank">Pino(iOS)</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#分享目标"><span class="nav-number">1.</span> <span class="nav-text">分享目标</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-多线程之间通信机制"><span class="nav-number">1.0.1.</span> <span class="nav-text">1.1 多线程之间通信机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-原子性操作"><span class="nav-number">1.0.2.</span> <span class="nav-text">1.2 原子性操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-MESI缓存行"><span class="nav-number">1.0.3.</span> <span class="nav-text">1.3 MESI缓存行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-Javap命令详解"><span class="nav-number">1.0.4.</span> <span class="nav-text">1.4 Javap命令详解</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2、多线程下共享变量引发问题"><span class="nav-number">1.1.</span> <span class="nav-text">2、多线程下共享变量引发问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-缓存不一致及不可见问题"><span class="nav-number">1.1.1.</span> <span class="nav-text">2.1 缓存不一致及不可见问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-原子性问题"><span class="nav-number">1.1.2.</span> <span class="nav-text">2.2 原子性问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-1-内存原子操作流程"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">2.2.1 内存原子操作流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-2-字节码跟踪流程"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">2.2.2 字节码跟踪流程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3、-解决方案"><span class="nav-number">1.2.</span> <span class="nav-text">3、 解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-总线加锁机制（性能太低）"><span class="nav-number">1.2.1.</span> <span class="nav-text">3.1 总线加锁机制（性能太低）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-MESI缓存一致性协议"><span class="nav-number">1.2.2.</span> <span class="nav-text">3.2 MESI缓存一致性协议</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4、指令重排序"><span class="nav-number">1.3.</span> <span class="nav-text">4、指令重排序</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-数据依赖性"><span class="nav-number">1.3.1.</span> <span class="nav-text">4.1 数据依赖性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-as-if-serial语义"><span class="nav-number">1.3.2.</span> <span class="nav-text">4.2 as-if-serial语义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-happens-before规则"><span class="nav-number">1.3.3.</span> <span class="nav-text">4.3 happens-before规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-顺序一致性"><span class="nav-number">1.3.4.</span> <span class="nav-text">4.4 顺序一致性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5、内存屏障"><span class="nav-number">1.4.</span> <span class="nav-text">5、内存屏障</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-什么是内存屏障？"><span class="nav-number">1.4.1.</span> <span class="nav-text">5.1 什么是内存屏障？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-内存屏障和happens-before是什么关系？"><span class="nav-number">1.4.2.</span> <span class="nav-text">5.2 内存屏障和happens-before是什么关系？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-内存屏障分类"><span class="nav-number">1.4.3.</span> <span class="nav-text">5.3 内存屏障分类</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#5-3-1-LoadLoad屏障"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">5.3.1 LoadLoad屏障</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-3-2-StoreStore屏障"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">5.3.2 StoreStore屏障</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-3-3-LoadStore屏障"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">5.3.3 LoadStore屏障</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-3-4-StoreLoad屏障"><span class="nav-number">1.4.3.4.</span> <span class="nav-text">5.3.4 StoreLoad屏障</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6、源码跟踪"><span class="nav-number">1.5.</span> <span class="nav-text">6、源码跟踪</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7、写在最后"><span class="nav-number">1.6.</span> <span class="nav-text">7、写在最后</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Keanu</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">172k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">2:36</span>
  
</div>






  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.1.1</div>




        








        
      </div>
    </footer>

    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  















  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script src="/js/utils.js?v=7.1.1"></script>

  <script src="/js/motion.js?v=7.1.1"></script>



  
  


  <script src="/js/affix.js?v=7.1.1"></script>

  <script src="/js/schemes/pisces.js?v=7.1.1"></script>



  
  <script src="/js/scrollspy.js?v=7.1.1"></script>
<script src="/js/post-details.js?v=7.1.1"></script>



  


  <script src="/js/next-boot.js?v=7.1.1"></script>


  

  

  

  
  
  <script id="dsq-count-scr" src="https://keanu96.disqus.com/count.js" async></script>


<script>
  var disqus_config = function() {
    this.page.url = "http://keanu96.github.io/deep-into-JMM/";
    this.page.identifier = "deep-into-JMM/";
    this.page.title = '深入理解Java内存模型(JMM)及Volatile关键字（转载）';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://keanu96.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    loadComments();
  
</script>





  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>


  

  

  

  

  

  

  

  

  



</body>
</html>
