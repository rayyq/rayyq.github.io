<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
<title>分类: Java - Keanu</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



    <meta name="description" content="Keanu 的技术小记">
<meta name="keywords" content="Java,Tech">
<meta property="og:type" content="website">
<meta property="og:title" content="Keanu">
<meta property="og:url" content="http://keanu96.github.io/categories/Java/index.html">
<meta property="og:site_name" content="Keanu">
<meta property="og:description" content="Keanu 的技术小记">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://keanu96.github.io/images/og_image.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Keanu">
<meta name="twitter:description" content="Keanu 的技术小记">
<meta name="twitter:image" content="http://keanu96.github.io/images/og_image.png">







<link rel="icon" href="/images/PacMan.ico">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<!-- <body class="is-3-column"> -->
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                Keanu
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item" href="/">首页</a>
                
                <a class="navbar-item" href="/archives">归档</a>
                
                <a class="navbar-item" href="/categories">分类</a>
                
                <a class="navbar-item" href="/tags">标签</a>
                
                <a class="navbar-item" href="/about">关于我</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    
                    <a class="navbar-item" target="_blank" title="Download on GitHub" href="https://github.com/keanu96">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main"><div class="card">
    <div class="card-content">
        <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li><a href="/categories">分类</a></li>
            
            <li class="is-active"><a href="#" aria-current="page">Java</a></li>
        </ul>
        </nav>
    </div>
</div>

    <div class="card">
    
    <div class="card-image">
        <a href="/deep-into-JMM/" class="image is-7by1">
            <img class="thumbnail" src="/deep-into-JMM/thumbnail.jpg" alt="深入理解Java内存模型(JMM)及Volatile关键字（转载）">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-10-28T14:45:52.000Z">2019-10-28</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Java/">Java</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 6863 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/deep-into-JMM/">深入理解Java内存模型(JMM)及Volatile关键字（转载）</a>
            
        </h1>
        <div class="content">
            <blockquote>
<p>转载自 <a href="[https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM">深入理解Java内存模型(JMM)及Volatile关键字</a>%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/](<a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM)及Volatile关键字/" target="_blank" rel="noopener">https://sccarterrans.github.io/深入理解Java内存模型(JMM)及Volatile关键字/</a>)</p>
</blockquote>
<h2 id="分享目标"><a href="#分享目标" class="headerlink" title="分享目标"></a>分享目标</h2><p>本文通过Java volatile探讨以下问题</p>
<ul>
<li>Volatile多线程引发的缓存一致性问题</li>
<li>Volatile多线程引发的不可见问题</li>
<li>Volatile多线程引发的原子性问题</li>
<li>指令重排序含义及相关语义和规则</li>
<li>内存屏障的分类和使用</li>
<li>源码跟踪</li>
</ul>
<h4 id="1-1-多线程之间通信机制"><a href="#1-1-多线程之间通信机制" class="headerlink" title="1.1 多线程之间通信机制"></a>1.1 多线程之间通信机制</h4><p>线程之间的通信机制有两种：<strong>共享内存</strong>和<strong>消息传递</strong>,Java的并发采用的是共享内存模型机制。</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener"><img src="https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM" alt="共享内存通信">%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/13.jpg)</a>及Volatile关键字/13.jpg)</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener">共享内存通信</a>及Volatile关键字/13.jpg)</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener"><img src="https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM" alt="消息传递通信">%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/14.jpg)</a>及Volatile关键字/14.jpg)</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener">消息传递通信</a>及Volatile关键字/14.jpg)</p>
<h4 id="1-2-原子性操作"><a href="#1-2-原子性操作" class="headerlink" title="1.2 原子性操作"></a>1.2 原子性操作</h4><p>在探讨问题之前需要先了解一下JMM的内存模型提供的八大原子性操作：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">read(读取): 从主内存读取数据</span><br><span class="line">load(载入): 将主内存读取到的数据写入工作内存中</span><br><span class="line">use(使用): 从工作内存读取数据来计算</span><br><span class="line">assign(赋值): 将计算好的值重新赋值到工作内存中</span><br><span class="line">store(存储): 将工作内存数据写入主内存读写缓冲(loadStoreBuffer)</span><br><span class="line">write(写入): 将读写缓冲的变量赋值给主内存中的变量</span><br><span class="line">lock(锁定): 将读写缓冲中共享变量加锁,标识为线程独占状态</span><br><span class="line">unlock(解锁): 将读写缓冲中共享变量解锁,解锁后其他线程可以锁定该变量</span><br></pre></td></tr></table></figure>
<h4 id="1-3-MESI缓存行"><a href="#1-3-MESI缓存行" class="headerlink" title="1.3 MESI缓存行"></a>1.3 MESI缓存行</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MESI协议是以缓存行(缓存的基本数据单位，在Intel的CPU上一般是64字节)的几个状态来命名的(全名是Modified、Exclusive、 Share or Invalid)。该协议要求在每个缓存行上维护两个状态位，使得每个数据单位可能处于M、E、S和I这四种状态之一，各种状态含义如下：</span><br><span class="line">M：所有CPU把缓存状态改为I之后，会向主内存同步数据</span><br><span class="line">E：独占的。处于这一状态的数据，只有在本CPU中有缓存，且其数据没有修改，即与内存中一致</span><br><span class="line">S：共享的。处于这一状态的数据在多个CPU中都有缓存，且与内存一致</span><br><span class="line">I：无效的。本CPU中的这份缓存已经无效</span><br></pre></td></tr></table></figure>
<h4 id="1-4-Javap命令详解"><a href="#1-4-Javap命令详解" class="headerlink" title="1.4 Javap命令详解"></a>1.4 Javap命令详解</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">用法: javap &lt;options&gt; &lt;classes&gt;</span><br><span class="line">其中, 可能的选项包括:</span><br><span class="line">  -help  --help  -?        输出此用法消息</span><br><span class="line">  -version                 版本信息</span><br><span class="line">  -v  -verbose             输出附加信息</span><br><span class="line">  -l                       输出行号和本地变量表</span><br><span class="line">  -public                  仅显示公共类和成员</span><br><span class="line">  -protected               显示受保护的/公共类和成员</span><br><span class="line">  -package                 显示程序包/受保护的/公共类</span><br><span class="line">                           和成员 (默认)</span><br><span class="line">  -p  -private             显示所有类和成员</span><br><span class="line">  -c                       对代码进行反汇编</span><br><span class="line">  -s                       输出内部类型签名</span><br><span class="line">  -sysinfo                 显示正在处理的类的</span><br><span class="line">                           系统信息 (路径, 大小, 日期, MD5 散列)</span><br><span class="line">  -constants               显示最终常量</span><br><span class="line">  -classpath &lt;path&gt;        指定查找用户类文件的位置</span><br><span class="line">  -cp &lt;path&gt;               指定查找用户类文件的位置</span><br><span class="line">  -bootclasspath &lt;path&gt;    覆盖引导类文件的位置</span><br></pre></td></tr></table></figure>
<h3 id="2、多线程下共享变量引发问题"><a href="#2、多线程下共享变量引发问题" class="headerlink" title="2、多线程下共享变量引发问题"></a>2、多线程下共享变量引发问题</h3><h4 id="2-1-缓存不一致及不可见问题"><a href="#2-1-缓存不一致及不可见问题" class="headerlink" title="2.1 缓存不一致及不可见问题"></a>2.1 缓存不一致及不可见问题</h4><p>多线程情况下未添加volatile关键字修饰导致出现死循环：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public class VolatileTest &#123;</span><br><span class="line"></span><br><span class="line">    private static boolean initFlag = false;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        new Thread(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                System.out.println(&quot;waiting data...&quot;);</span><br><span class="line">                while (!initFlag) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(&quot;success...&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(2000);</span><br><span class="line"></span><br><span class="line">        new Thread(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                prepareData();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void prepareData() &#123;</span><br><span class="line">        System.out.println(&quot;prepareData...&quot;);</span><br><span class="line">        initFlag = true;</span><br><span class="line">        System.out.println(&quot;prepare commit...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">运行结果：</span><br><span class="line">waiting data...</span><br><span class="line">prepareData...</span><br><span class="line">prepare commit...</span><br></pre></td></tr></table></figure>
<p>线程一永远处理阻塞状态，无法获取到线程2修改后的最新数据；</p>
<p>上述代码的交互流程：</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener"><img src="https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM" alt="线程不可见">%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/1.jpg)</a>及Volatile关键字/1.jpg)</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener">线程不可见</a>及Volatile关键字/1.jpg)</p>
<p>T1和T2同时从主内存加载initFlag = false，各自进行代码执行。T二修改initFlag为true并写入主内存；而T1并不知晓，initFlag变量是属于有效状态一直处于false，代码处于while中一直无法跳出，导致死循环。</p>
<h4 id="2-2-原子性问题"><a href="#2-2-原子性问题" class="headerlink" title="2.2 原子性问题"></a>2.2 原子性问题</h4><p>volatile关键字并不能保证原子性，利用volatile来修饰Increment的变量是一种错误的写法：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class AtomicDemo implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">    private volatile static int count = 0;</span><br><span class="line"></span><br><span class="line">    private static ExecutorService executor = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        for (int i = 0; i &lt; 1000; i++) &#123;</span><br><span class="line">            executor.submit(new AtomicDemo());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(&quot;count累加运行结果：&quot; + count);</span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">count累加运行结果：967</span><br><span class="line">count累加运行结果：958</span><br></pre></td></tr></table></figure>
<p>上述代码运行结果永远是小于等于1000，那么为什么不是每次都是1000呢？</p>
<h5 id="2-2-1-内存原子操作流程"><a href="#2-2-1-内存原子操作流程" class="headerlink" title="2.2.1 内存原子操作流程"></a>2.2.1 内存原子操作流程</h5><p>通过内存原子操作演练一下count++的流程：</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener"><img src="https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM" alt="原子性问题">%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/2.jpg)</a>及Volatile关键字/2.jpg)</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener">原子性问题</a>及Volatile关键字/2.jpg)</p>
<p>T1T2线程同时读取(read)和加载(load)count=0到各自的工作内存，然后复制给执行引擎进行Increment计算，T2 Increment后assign count=1回到工作内存，这时候T1也是同样的操作，当然这时候T1也可以还在执行引擎计算未执行assign操作。这时候T2需要把修改后的数据(storeBuffer)强制写回主内存（StoreLoad屏障），在这之前需要进行lock操作锁定主内存(绿色)count变量，当回写操作通过总线MESI缓存一致性协议时，其他线程会通过CPU总线嗅探机制监听到，各自把各自工作内存中的count变量状态设置为失效状态。那么这时候T1可能已经是Increment后的值count=1,那么T1再次计算count累加时需要重新从主内存再次读取和加载，获取到count=1。实际上T1和T2已经对count进行了2次Increment按道理来说这时候count的值为2，而其他线程这时候拿到的却是1，导致count累加值丢失。</p>
<p>由上图可以看出count++并非单个原子性操作，它需要先read-&gt;load-&gt;use-&gt;assign-&gt;store-&gt;write操作才能完成整个操作，虽然上述单个操作都是原子性操作，但是组合起来就是非原子性了。</p>
<h5 id="2-2-2-字节码跟踪流程"><a href="#2-2-2-字节码跟踪流程" class="headerlink" title="2.2.2 字节码跟踪流程"></a>2.2.2 字节码跟踪流程</h5><p>为了演示，我们尽可能使用少量代码，通过javap -v -p 命令对class文件进行字节码展示：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class VolatileTest &#123;</span><br><span class="line"></span><br><span class="line">    volatile int i = 1;</span><br><span class="line"></span><br><span class="line">    public void inc()&#123;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        new VolatileTest().inc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反汇编后的字节码:</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public class com.example.demo.VolatileTest</span><br><span class="line">&#123;</span><br><span class="line">  volatile int i;</span><br><span class="line">    descriptor: I</span><br><span class="line">    flags: ACC_VOLATILE //volatile i 添加ACC_VOLATILE修饰符</span><br><span class="line"></span><br><span class="line">  public com.example.demo.VolatileTest();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC </span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: aload_0</span><br><span class="line">         5: iconst_1</span><br><span class="line">         6: putfield      #2                  // Field i:I</span><br><span class="line">         9: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 8: 0</span><br><span class="line">        line 10: 4</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0      10     0  this   Lcom/example/demo/VolatileTest;</span><br><span class="line">            </span><br><span class="line">  public void inc();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC //方法访问修饰符</span><br><span class="line">    Code:</span><br><span class="line">      stack=3, locals=1, args_size=1</span><br><span class="line">         0: aload_0 //取this对应的对应引用值，压入操作数栈,也就是VolatileTest的实例，即getfield的主体</span><br><span class="line">         1: dup //复制栈顶数值，并压入栈顶,此时栈中有两个值，都是this对象引用</span><br><span class="line">         2: getfield      #2                  // Field i:I //获取对象i字段，将其值压入栈顶</span><br><span class="line">         5: iconst_1 //int型常量1进栈</span><br><span class="line">         6: iadd //弹出栈中的i值和常量1，进行加操作，并将结果压入栈</span><br><span class="line">         7: putfield      #2                  // Field i:I //赋值对象i字段 i=1</span><br><span class="line">        10: return //return void</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 13: 0</span><br><span class="line">        line 14: 10</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0      11     0  this   Lcom/example/demo/VolatileTest;//看这里</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>字节码中inc方法中第2、6、7分别3步操作getfield-&gt;iadd-&gt;putfield，这就是同学们说的i++并不是单个原子性操作，多线程情况下getfield并不能保证获取到最新值，造成数据操作丢失，出现原子性问题。</p>
<h3 id="3、-解决方案"><a href="#3、-解决方案" class="headerlink" title="3、 解决方案"></a>3、 解决方案</h3><ul>
<li>总线加锁</li>
<li>共享变量加锁</li>
</ul>
<h4 id="3-1-总线加锁机制（性能太低）"><a href="#3-1-总线加锁机制（性能太低）" class="headerlink" title="3.1 总线加锁机制（性能太低）"></a>3.1 总线加锁机制（性能太低）</h4><p>最早期的X86解决方案是使用总线加锁机制来实现共享变量数据一致性问题。从主内存读取数据到高速缓存，会在总线对这个数据进行加锁，这样其他CPU没法去读或者写这个数据，直到锁释放后才能给其他CPU操作数据，这个机制虽然解决了数据一致性问题，但是对多核CPU来说由原来的并行执行改为串行执行，性能非常的低下；</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener"><img src="https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM" alt="总线加锁">%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/3.jpg)</a>及Volatile关键字/3.jpg)</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener">总线加锁</a>及Volatile关键字/3.jpg)</p>
<h4 id="3-2-MESI缓存一致性协议"><a href="#3-2-MESI缓存一致性协议" class="headerlink" title="3.2 MESI缓存一致性协议"></a>3.2 MESI缓存一致性协议</h4><p>多个CPU从主内存读取共享数据到各自的高速缓存，当其中某个CPU修改了缓存里的数据，该数据会马上同步回主内存，其他CPU通过总线<strong>嗅探机制</strong>可以感知到数据的变化从而将自己缓存里的数据设置<strong>失效</strong>，当线程处理存储操作时会在store前调用lock操作，数据write主内存后进行unLock操作。如果多个线程都来修改共享变量就会进行锁竞争；</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener"><img src="https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM" alt="MESI缓存一致性协议">%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/4.jpg)</a>及Volatile关键字/4.jpg)</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener">MESI缓存一致性协议</a>及Volatile关键字/4.jpg)</p>
<h3 id="4、指令重排序"><a href="#4、指令重排序" class="headerlink" title="4、指令重排序"></a>4、指令重排序</h3><p>重排序是指编译器和处理器为了优化程序性能而对指令序列进行重新排序的一种手段。重排序分为两类：<strong>编译期重排序</strong>和<strong>运行期重排序</strong>，分别对应编译时和运行时环境。</p>
<ul>
<li>编译期重排序的典型就是通过调整指令顺序，在单线程下不改变程序语义的前提下，尽可能减少寄存器的读取、存储次数，充分复用寄存器的存储值。</li>
</ul>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">假设第一条指令计算一个值赋给变量A并存放在寄存器中，第二条指令与A无关但需要占用寄存器（假设它将占用A所在的那个寄存器），第三条指令使用A的值且与第二条指令无关。那么如果按照顺序一致性模型，A在第一条指令执行过后被放入寄存器，在第二条指令执行时A不再存在，第三条指令执行时A重新被读入寄存器，而这个过程中，A的值没有发生变化。通常编译器都会交换第二和第三条指令的位置，这样第一条指令结束时A存在于寄存器中，接下来可以直接从寄存器中读取A的值，降低了重复读取的开销。</span><br></pre></td></tr></table></figure>
<ul>
<li>运行期重排序包含指令并行的重排和内存系统的重排<ul>
<li>指令并行重排序是通过处理器采用了指令级并行技术来将多条指令重叠执行。需要建立在数据不存在依赖性时处理器可以改变语句对应的机器指令的执行顺序的情况下</li>
<li>内存系统重排序是指处理器使用缓存和读写缓冲区，这使得加载(load)和存储(store)操作看上去可能是在乱序执行</li>
</ul>
</li>
</ul>
<p>从 java 源代码到最终实际执行的指令序列，会分别经历下面三种重排序：</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener"><img src="https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM" alt="指令重排序">%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/12.jpg)</a>及Volatile关键字/12.jpg)</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener">指令重排序</a>及Volatile关键字/12.jpg)</p>
<h4 id="4-1-数据依赖性"><a href="#4-1-数据依赖性" class="headerlink" title="4.1 数据依赖性"></a>4.1 数据依赖性</h4><p>如果两个操作访问同一个变量，且这两个操作中有一个为写操作，此时这两个操作之间就存在数据依赖性。数据依赖分为下列3种类型：</p>
<table>
<thead>
<tr>
<th style="text-align:left">名称</th>
<th style="text-align:left">代码示例</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">写后读</td>
<td style="text-align:left">a=1;b=a;</td>
<td style="text-align:left">写一个变量后，再读这个变量</td>
</tr>
<tr>
<td style="text-align:left">写后写</td>
<td style="text-align:left">a=1;a=2;</td>
<td style="text-align:left">写一个变量后，再写这个变量</td>
</tr>
<tr>
<td style="text-align:left">读后写</td>
<td style="text-align:left">a=b;b=1;</td>
<td style="text-align:left">读一个变量后，再写这个变量</td>
</tr>
</tbody>
</table>
<p>上面3种情况，只要重排序两个操作的执行顺序，程序的执行结果就会被改变。前面提到过，编译器和处理器可能会对操作做重排序。编译器和处理器在重排序时，会遵守数据依赖性，编译器和处理器不会改变存在数据依赖关系的两个操作的执行顺序。这里所说的数据依赖性仅针对单个处理器中执行的指令序列和单个线程中执行的操作，不同处理器之间和不同线程之间的数据依赖性不被编译器和处理器考虑。</p>
<h4 id="4-2-as-if-serial语义"><a href="#4-2-as-if-serial语义" class="headerlink" title="4.2 as-if-serial语义"></a>4.2 as-if-serial语义</h4><p>as-if-serial语义的意思是：不管怎么重排序程序的执行结果不能被改变(<strong>单线程</strong>)。编译器、runtime和处理器都必须遵守as-if-serial语义。为了遵守as-if-serial语义，编译器和处理器不会对存在<strong>数据依赖关系</strong>的操作做重排序，因<br>为这种重排序会改变执行结果。但是，如果操作之间不存在数据依赖关系，这些操作就可能被编译器和处理器重排序。代码示例，计算圆的面积：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">double pi = 3.14; // A</span><br><span class="line">double r = 1.0; // B</span><br><span class="line">double area = pi * r * r; // C</span><br></pre></td></tr></table></figure>
<p>代码C依赖A和B,代码依赖操作流程：</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener"><img src="https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM" alt="img">%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/5.jpg)</a>及Volatile关键字/5.jpg)</p>
<p>A和B之间没有数据依赖关系，编译器和处理器可以重排序A和B之间的执行顺序。该程序的两种执行顺序如下：</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener"><img src="https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM" alt="img">%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/6.jpg)</a>及Volatile关键字/6.jpg)</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">area = 3.14</span><br></pre></td></tr></table></figure>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener"><img src="https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM" alt="img">%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/7.jpg)</a>及Volatile关键字/7.jpg)</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">area = 3.14</span><br></pre></td></tr></table></figure>
<p>编译器和处理器重排序后，不仅优化了编译指令还能保证最终执行结果也一致。</p>
<p>as-if-serial语义把<strong>单线程</strong>程序保护了起来，遵守as-if-serial语义的编译器、runtime和处理器共同为编写单线程程序的程序员创建了一个幻觉：单线程程序是按程序的顺序来执行的。asif-serial语义使单线程程序员无需担心重排序会干扰他们，也无需担心内存可见性问题。</p>
<h4 id="4-3-happens-before规则"><a href="#4-3-happens-before规则" class="headerlink" title="4.3 happens-before规则"></a>4.3 happens-before规则</h4><p>根据happens-before的程序顺序规则，上面计算圆的面积的示例代码存在3个happensbefore关系。</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A　happens-before B</span><br><span class="line">B　happens-before C</span><br><span class="line">A　happens-before C</span><br></pre></td></tr></table></figure>
<p>这里的第3个happens-before关系，是根据happens-before的传递性推导出来的。</p>
<p>这里A happens-before B，但实际执行时B却可以排在A之前执行（看上面的重排序后的执行顺序）。如果A happens-before B，JMM并不要求A一定要在B之前执行。JMM仅仅要求前一个操作（执行的结果）对后一个操作可见(A和B对C可见)，且前一个操作按顺序排在第二个操作之前（A和B排在C之前）。</p>
<p>这里操作A的执行结果不需要对操作B可见；而且重排序操作A和操作B后的执行结果，与操作A和操作B按happens-before顺序执行的结果一致。在这种情况下，JMM会认为这种重排序并不非法（not illegal），JMM允许这种重排序。</p>
<p>在计算机中，软件技术和硬件技术有一个共同的目标：在不改变程序执行结果的前提下，尽可能提高并行度。编译器和处理器遵从这一目标，从happens-before的定义我们可以看出，JMM同样遵从这一目标。</p>
<h4 id="4-4-顺序一致性"><a href="#4-4-顺序一致性" class="headerlink" title="4.4 顺序一致性"></a>4.4 顺序一致性</h4><p>顺序一致性内存模型是一个理论参考模型，在设计的时候，处理器的内存模型和编程语言的内存模型都会以顺序一致性内存模型作为参照。尽管最终执行指令在执行时并不一定按照我们所编写的顺序执行，但毋庸置疑的是，<strong>在单线程环境下，指令执行的最终效果应当与其在顺序执行下的效果一致</strong>，否则这种优化便会失去意义。</p>
<p>通常无论是在编译期还是运行期进行的指令重排序，都会满足上面的原则。</p>
<h3 id="5、内存屏障"><a href="#5、内存屏障" class="headerlink" title="5、内存屏障"></a>5、内存屏障</h3><h4 id="5-1-什么是内存屏障？"><a href="#5-1-什么是内存屏障？" class="headerlink" title="5.1 什么是内存屏障？"></a>5.1 什么是内存屏障？</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A memory barrier, also known as a membar, memory fence or fence instruction, is a type of barrier instruction that causes a CPU or compiler to enforce an ordering constraint on memory operations issued before and after the barrier instruction. This typically means that operations issued prior to the barrier are guaranteed to be performed before operations issued after the barrier.</span><br><span class="line"></span><br><span class="line">内存屏障，也称内存栅栏，内存栅障，屏障指令等， 是一类同步屏障指令，是CPU或编译器在对内存随机访问的操作中的一个同步点，使得此点之前的所有读写操作都执行后才可以开始执行此点之后的操作。</span><br></pre></td></tr></table></figure>
<h4 id="5-2-内存屏障和happens-before是什么关系？"><a href="#5-2-内存屏障和happens-before是什么关系？" class="headerlink" title="5.2 内存屏障和happens-before是什么关系？"></a>5.2 内存屏障和happens-before是什么关系？</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">happens-before是JSR-133规范之一，内存屏障是CPU指令。可以理解前者是最终目的，后者是实现手段。</span><br></pre></td></tr></table></figure>
<h4 id="5-3-内存屏障分类"><a href="#5-3-内存屏障分类" class="headerlink" title="5.3 内存屏障分类"></a>5.3 内存屏障分类</h4><p>内存屏障分为<strong>Store屏障</strong>和<strong>Load屏障</strong>两大类：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">基于保守策略的JMM内存屏障插入策略(绿色操作标志)：</span><br><span class="line">在每个volatile写操作的前面插入一个StoreStore屏障</span><br><span class="line">在每个volatile写操作的后面插入一个StoreLoad屏障</span><br><span class="line">在每个volatile读操作的后面插入一个LoadLoad屏障</span><br><span class="line">在每个volatile读操作的后面插入一个LoadStore屏障</span><br><span class="line">上述内存屏障插入策略非常保守，但它可以保证在任意处理器平台，任意的程序中都能得到正确的volatile内存语义,在实际执行时，只要不改变volatile写-读的内存语义，编译器可以根据具体情况省略不必要的屏障。</span><br></pre></td></tr></table></figure>
<h5 id="5-3-1-LoadLoad屏障"><a href="#5-3-1-LoadLoad屏障" class="headerlink" title="5.3.1 LoadLoad屏障"></a>5.3.1 LoadLoad屏障</h5><p>抽象场景：Load1; LoadLoad; Load2</p>
<p>Load1 和 Load2 代表两条读取指令。Load2读取数据被访问（use）前，要保证Load1读取的数据被读取完毕。</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener"><img src="https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM" alt="LoadLoad">%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/8.jpg)</a>及Volatile关键字/8.jpg)</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener">LoadLoad</a>及Volatile关键字/8.jpg)</p>
<h5 id="5-3-2-StoreStore屏障"><a href="#5-3-2-StoreStore屏障" class="headerlink" title="5.3.2 StoreStore屏障"></a>5.3.2 StoreStore屏障</h5><p>抽象场景：Store1; StoreStore; Store2</p>
<p>Store1 和 Store2代表两条写入指令。Store2写入（store）执行前，要保证Store1的写入操作对其它处理器可见。</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener"><img src="https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM" alt="StoreStore">%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/9.jpg)</a>及Volatile关键字/9.jpg)</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener">StoreStore</a>及Volatile关键字/9.jpg)</p>
<h5 id="5-3-3-LoadStore屏障"><a href="#5-3-3-LoadStore屏障" class="headerlink" title="5.3.3 LoadStore屏障"></a>5.3.3 LoadStore屏障</h5><p>抽象场景：Load1; LoadStore; Store2</p>
<p>Load1代表读取指令，Store2代表写入指令。Store2被写入（store）执行前，要保证Load1读取的数据被读取完毕。</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener"><img src="https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM" alt="LoadStore">%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/10.jpg)</a>及Volatile关键字/10.jpg)</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener">LoadStore</a>及Volatile关键字/10.jpg)</p>
<h5 id="5-3-4-StoreLoad屏障"><a href="#5-3-4-StoreLoad屏障" class="headerlink" title="5.3.4 StoreLoad屏障"></a>5.3.4 StoreLoad屏障</h5><p>抽象场景：Store1; StoreLoad; Load2</p>
<p>Store1代表写入指令，Load2代表读取指令。Load2读取操作（read）执行前，要保证Store1的写入对所有处理器可见。StoreLoad屏障的开销是四种屏障中最大的。</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener"><img src="https://sccarterrans.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM" alt="StoreLoad">%E5%8F%8AVolatile%E5%85%B3%E9%94%AE%E5%AD%97/11.jpg)</a>及Volatile关键字/11.jpg)</p>
<p><a href="https://sccarterrans.github.io/深入理解Java内存模型(JMM" target="_blank" rel="noopener">StoreLoad</a>及Volatile关键字/11.jpg)</p>
<h3 id="6、源码跟踪"><a href="#6、源码跟踪" class="headerlink" title="6、源码跟踪"></a>6、源码跟踪</h3><p>在2.2.2 字节码流程基础上进行hotspot源码跟踪，被volatile修饰的字段会多一个 <strong>ACC_VOLATILE</strong>的flag，在给字段赋值的时候通过<code>BytecodeInterpreter</code>解释器来执行</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">##src/share/vm/interpreter/bytecodeInterpreter.cpp:1831</span><br><span class="line"></span><br><span class="line">CASE(_putstatic):</span><br><span class="line">        &#123;</span><br><span class="line">          u2 index = Bytes::get_native_u2(pc+1);</span><br><span class="line">          ConstantPoolCacheEntry* cache = cp-&gt;entry_at(index);</span><br><span class="line">          if (!cache-&gt;is_resolved((Bytecodes::Code)opcode)) &#123;</span><br><span class="line">            CALL_VM(InterpreterRuntime::resolve_get_put(THREAD, (Bytecodes::Code)opcode),</span><br><span class="line">                    handle_exception);</span><br><span class="line">            cache = cp-&gt;entry_at(index);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">#ifdef VM_JVMTI</span><br><span class="line">          if (_jvmti_interp_events) &#123;</span><br><span class="line">           //代码省略</span><br><span class="line">          &#125;</span><br><span class="line">#endif /* VM_JVMTI */</span><br><span class="line">          //判断i是否被volatile修饰</span><br><span class="line">          if (cache-&gt;is_volatile()) &#123;</span><br><span class="line">            if (tos_type == itos) &#123;</span><br><span class="line">                //整形字段修改</span><br><span class="line">              obj-&gt;release_int_field_put(field_offset, STACK_INT(-1));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">              //代码省略</span><br><span class="line">            &#125;</span><br><span class="line">            OrderAccess::storeload();//赋值完成后插入storeload内存屏障，禁止上面的volatile写和下面的volatile读写重排序</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            //非volatile修饰处理 代码省略</span><br><span class="line">          &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>首先我们关注cache-&gt;is_volatile()这段代码，cache是<strong>i</strong>在常量池缓存中的一个实例，这段代码是校验cache是否是被 volatile修饰，代码如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">##src/share/vm/utilities/accessFlags.hpp:103</span><br><span class="line">public:</span><br><span class="line">  // Java access flags</span><br><span class="line">  // ..代码省略</span><br><span class="line">  bool is_volatile    () const         &#123; return (_flags &amp; JVM_ACC_VOLATILE    ) != 0; &#125;</span><br></pre></td></tr></table></figure>
<p>is_volatile是判断是否有 ACC_VOLATILE的flag标志，很显然变量<strong>i</strong>是符合这个条件的，所以结果必然返回true。接着，根据当前字段的类型来给<strong>i</strong>赋值，执行 release_int_field_put方法赋值。</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">##src/share/vm/oops/oop.inline.hpp:384</span><br><span class="line">inline void oopDesc::release_int_field_put(int offset, jint contents)</span><br><span class="line">&#123; OrderAccess::release_store(int_field_addr(offset), contents);  &#125;</span><br></pre></td></tr></table></figure>
<p>赋值的动作被包装了一层，看看 OrderAccess::release_store做了什么事情呢？找到 OrderAccess::release_store的实现，代码如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">##src/os_cpu/linux_x86/vm/orderAccess_linux_x86.inline.hpp:82</span><br><span class="line">inline void OrderAccess::release_store(volatile jbyte*   p, jbyte   v) &#123; *p = v; &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到其实Java的volatile操作，在JVM实现层面第一步是给予了C++的原语实现。c/c++中的volatile关键字，用来修饰变量，通常用于语言级别的 memory barrier。被volatile声明的变量表示随时可能发生变化，每次使用时，都必须从变量<strong>i</strong>对应的内存地址读取，编译器对操作该变量的代码不再进行优化。</p>
<p>赋值操作完成以后，我们会发现还会执行一个 OrderAccess::storeload();的代码，它其实就是一个storeload内存屏障，JVM层面的四种内存屏障的定义以及实现</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">##src/os_cpu/linux_x86/vm/orderAccess_linux_x86.inline.hpp:34</span><br><span class="line">inline void OrderAccess::loadload()   &#123; acquire(); &#125;</span><br><span class="line">inline void OrderAccess::storestore() &#123; release(); &#125;</span><br><span class="line">inline void OrderAccess::loadstore()  &#123; acquire(); &#125;</span><br><span class="line">inline void OrderAccess::storeload()  &#123; fence(); &#125;</span><br><span class="line"></span><br><span class="line">##当调用storeload屏障时，它会调用fence()方法</span><br><span class="line">inline void OrderAccess::fence() &#123;</span><br><span class="line">  if (os::is_MP()) &#123;//返回是否多处理器,如果是多处理器才有必要增加内存屏障</span><br><span class="line">    // always use locked addl since mfence is sometimes expensive</span><br><span class="line">#ifdef AMD64</span><br><span class="line">    //__asm__ volatile 嵌入汇编指令</span><br><span class="line">    //lock 汇编指令,lock指令会锁住操作的缓存行,也就是缓存锁的实现</span><br><span class="line">    __asm__ volatile (&quot;lock; addl $0,0(%%rsp)&quot; : : : &quot;cc&quot;, &quot;memory&quot;);</span><br><span class="line">#else</span><br><span class="line">    __asm__ volatile (&quot;lock; addl $0,0(%%esp)&quot; : : : &quot;cc&quot;, &quot;memory&quot;);</span><br><span class="line">#endif</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>os::is_MP:判断是否是多核,如果是单核,那么就不存在内存不可见或者乱序的问题，<strong>volatile</strong>:禁止编译器对代码进行某些优化。<br>Lock :汇编指令，lock指令会锁住操作的缓存行(cacheline), 一般用于read-Modify-write的操作;用来保证后续的操作是原子的<br>cc：代表的是寄存器</p>
<p>memory：代表是内存</p>
<p>这边同时用了”cc”和”memory”,来通知编译器内存或者寄存器内的内容已经发生了修改,要重新生成加载指令(不可以从缓存寄存器中取),这边的read/write请求不能越过lock指令进行重排</p>
<h3 id="7、写在最后"><a href="#7、写在最后" class="headerlink" title="7、写在最后"></a>7、写在最后</h3><p>需要查看汇编指令的同学可以按照以下方式：</p>
<ul>
<li>获取到编译动态链接库文件,下载完毕后需要复制至${JAVA_HOME}/jre/bin/service目录下</li>
</ul>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">##windows版本 hsdis-amd64.dll</span><br><span class="line">链接: https://pan.baidu.com/s/1pxrT0ny3csuCRNlPRvegIA 提取码: qr4k</span><br></pre></td></tr></table></figure>
<ul>
<li>测试类启动时configuration配置VM otions参数</li>
</ul>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly VolatileTest(类名称) ##详细解释自行查阅</span><br></pre></td></tr></table></figure>
<p>hotspot源码下载地址:</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/sccarterrans/hotspot</span><br></pre></td></tr></table></figure>
<p>[参考资料]</p>
<p><a href="http://ifeve.com/jvm-reordering/" target="_blank" rel="noopener">http://ifeve.com/jvm-reordering/</a></p>
<p><a href="https://juejin.im/entry/593e0ab25c497d006b93cfb1" target="_blank" rel="noopener">https://juejin.im/entry/593e0ab25c497d006b93cfb1</a></p>
<p><a href="http://gityuan.com/2015/10/24/jvm-bytecode-grammar/" target="_blank" rel="noopener">http://gityuan.com/2015/10/24/jvm-bytecode-grammar/</a></p>
<p><a href="https://my.oschina.net/tantexian/blog/808032" target="_blank" rel="noopener">https://my.oschina.net/tantexian/blog/808032</a></p>
<p><a href="https://www.520mwx.com/view/32394" target="_blank" rel="noopener">https://www.520mwx.com/view/32394</a></p>
<p>《Java并发编程的艺术》</p>

        </div>
        
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-image">
        <a href="/volatile学习笔记/" class="image is-7by1">
            <img class="thumbnail" src="/volatile学习笔记/thumbnail.jpg" alt="volatile学习笔记">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-10-15T15:18:25.000Z">2019-10-15</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Java/">Java</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    9 分钟 读完 (大约 1303 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/volatile学习笔记/">volatile学习笔记</a>
            
        </h1>
        <div class="content">
            <p>volatile 应该经常听说或者用到的。它在并发编程中起到了什么作用呢？</p>
<ul>
<li>volatile 能禁止编译器和CPU对指令重排序</li>
<li>对 volatile 变量的操作插入内存屏障，保证内存的可见性</li>
</ul>
<p>这是我学习 volatile 的笔记，在这里记录一下。</p>
        </div>
        
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                <a class="button is-size-7 is-light" href="/volatile学习笔记/#more">阅读更多</a>
                </div>
            </div>
        </div>
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-image">
        <a href="/deep-in-synchronized/" class="image is-7by1">
            <img class="thumbnail" src="/deep-in-synchronized/thumbnail.jpg" alt="【Java 并发】synchornized学习笔记">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-09-07T01:44:19.000Z">2019-09-07</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Java/">Java</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    17 分钟 读完 (大约 2594 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/deep-in-synchronized/">【Java 并发】synchornized学习笔记</a>
            
        </h1>
        <div class="content">
            <p>我们在学习 Java 并发编程的时候，看到的最多的就是 synchronized 关键字了，它可以解决很多线程安全问题，随着深入学习，我们知道 synchronized 是一个重量级锁，效率相对于 Lock 来说并不是那么好。但是经过 Java 几个版本的优化之后，synchronized 并不显得那么笨重了。下面我们来看一下 synchronized 的实现机制，和 Java 对它进行了什么样的升级。</p>
        </div>
        
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                <a class="button is-size-7 is-light" href="/deep-in-synchronized/#more">阅读更多</a>
                </div>
            </div>
        </div>
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-image">
        <a href="/jvm-garbage-collection/" class="image is-7by1">
            <img class="thumbnail" src="/jvm-garbage-collection/thumbnail.jpeg" alt="Java 垃圾回收">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-07-22T14:17:08.000Z">2019-07-22</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Java/">Java</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    33 分钟 读完 (大约 4971 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/jvm-garbage-collection/">Java 垃圾回收</a>
            
        </h1>
        <div class="content">
            <p>关于 Java 回收的文章大同小异，我将我查阅的各种资料整合了一下，取文章中写的好的部分以及自我总结，写出这篇文章。</p>
        </div>
        
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                <a class="button is-size-7 is-light" href="/jvm-garbage-collection/#more">阅读更多</a>
                </div>
            </div>
        </div>
        
        
    </div>
</div>








</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="/images/avatar1.png" alt="Keanu">
                    
                    
                    <p class="is-size-4 is-block">
                        Keanu
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Don&#39;t be mediocre!
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Sichuan, China</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        11
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        7
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        9
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/keanu96" target="_blank">
                关注我</a>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Github" href="https://github.com/keanu96">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Envelope" href="mailto:leiyongqi1026@gmail.com">
                
                <i class="fas fa-envelope"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="RSS" href="/atom.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        

<div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://sccarterrans.github.io" target="_blank">
                    <span class="level-left">
                        <span class="level-item">辉</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">sccarterrans.github.io</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://github.com/P1nov" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Pino(iOS)</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">github.com</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>


    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Hexo/">
            <span class="level-start">
                <span class="level-item">Hexo</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Java/">
            <span class="level-start">
                <span class="level-item">Java</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Leetcode/">
            <span class="level-start">
                <span class="level-item">Leetcode</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a><ul><li>
        <a class="level is-marginless" href="/categories/Leetcode/Easy/">
            <span class="level-start">
                <span class="level-item">Easy</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li></ul></li><li>
        <a class="level is-marginless" href="/categories/Redis/">
            <span class="level-start">
                <span class="level-item">Redis</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Spring/">
            <span class="level-start">
                <span class="level-item">Spring</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Spring-Cloud/">
            <span class="level-start">
                <span class="level-item">Spring Cloud</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        
    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/Algorithm/" style="font-size: 15px;">Algorithm</a> <a href="/tags/Binary-Tree/" style="font-size: 10px;">Binary Tree</a> <a href="/tags/Eureka/" style="font-size: 10px;">Eureka</a> <a href="/tags/Hexo-博客搭建/" style="font-size: 10px;">Hexo 博客搭建</a> <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/Redis-持久化/" style="font-size: 10px;">Redis 持久化</a> <a href="/tags/Spring-IOC/" style="font-size: 10px;">Spring IOC</a> <a href="/tags/Spring-MVC/" style="font-size: 10px;">Spring MVC</a> <a href="/tags/并发/" style="font-size: 20px;">并发</a>
    </div>
</div>

        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <a href="/deep-into-JMM/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/deep-into-JMM/thumbnail.jpg" alt="深入理解Java内存模型(JMM)及Volatile关键字（转载）">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-10-28T14:45:52.000Z">2019-10-28</time></div>
                    <a href="/deep-into-JMM/" class="has-link-black-ter is-size-6">深入理解Java内存模型(JMM)及Volatile关键字（转载）</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Java/">Java</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/volatile学习笔记/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/volatile学习笔记/thumbnail.jpg" alt="volatile学习笔记">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-10-15T15:18:25.000Z">2019-10-15</time></div>
                    <a href="/volatile学习笔记/" class="has-link-black-ter is-size-6">volatile学习笔记</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Java/">Java</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/deep-in-eureka/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/deep-in-eureka/thumbnail.jpg" alt="微服务注册中心 Eureka 架构深入解读（转载）">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-10-03T13:15:06.000Z">2019-10-03</time></div>
                    <a href="/deep-in-eureka/" class="has-link-black-ter is-size-6">微服务注册中心 Eureka 架构深入解读（转载）</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Spring-Cloud/">Spring Cloud</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/deep-in-synchronized/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/deep-in-synchronized/thumbnail.jpg" alt="【Java 并发】synchornized学习笔记">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-09-07T01:44:19.000Z">2019-09-07</time></div>
                    <a href="/deep-in-synchronized/" class="has-link-black-ter is-size-6">【Java 并发】synchornized学习笔记</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Java/">Java</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/paxos-made-simple/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/paxos-made-simple/thumbnail.jpg" alt="Paxos Made Simple(译文)">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-08-22T12:55:35.000Z">2019-08-22</time></div>
                    <a href="/paxos-made-simple/" class="has-link-black-ter is-size-6">Paxos Made Simple(译文)</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">十月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">九月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/08/">
                <span class="level-start">
                    <span class="level-item">八月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">七月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/05/">
                <span class="level-start">
                    <span class="level-item">五月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Algorithm/">
                        <span class="tag">Algorithm</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Binary-Tree/">
                        <span class="tag">Binary Tree</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Eureka/">
                        <span class="tag">Eureka</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Hexo-博客搭建/">
                        <span class="tag">Hexo 博客搭建</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JVM/">
                        <span class="tag">JVM</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Redis-持久化/">
                        <span class="tag">Redis 持久化</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring-IOC/">
                        <span class="tag">Spring IOC</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring-MVC/">
                        <span class="tag">Spring MVC</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/并发/">
                        <span class="tag">并发</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
        
        </div>
    
</div>

                




<div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right ">
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/Algorithm/" style="font-size: 15px;">Algorithm</a> <a href="/tags/Binary-Tree/" style="font-size: 10px;">Binary Tree</a> <a href="/tags/Eureka/" style="font-size: 10px;">Eureka</a> <a href="/tags/Hexo-博客搭建/" style="font-size: 10px;">Hexo 博客搭建</a> <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/Redis-持久化/" style="font-size: 10px;">Redis 持久化</a> <a href="/tags/Spring-IOC/" style="font-size: 10px;">Spring IOC</a> <a href="/tags/Spring-MVC/" style="font-size: 10px;">Spring MVC</a> <a href="/tags/并发/" style="font-size: 20px;">并发</a>
    </div>
</div>

    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <a href="/deep-into-JMM/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/deep-into-JMM/thumbnail.jpg" alt="深入理解Java内存模型(JMM)及Volatile关键字（转载）">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-10-28T14:45:52.000Z">2019-10-28</time></div>
                    <a href="/deep-into-JMM/" class="has-link-black-ter is-size-6">深入理解Java内存模型(JMM)及Volatile关键字（转载）</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Java/">Java</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/volatile学习笔记/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/volatile学习笔记/thumbnail.jpg" alt="volatile学习笔记">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-10-15T15:18:25.000Z">2019-10-15</time></div>
                    <a href="/volatile学习笔记/" class="has-link-black-ter is-size-6">volatile学习笔记</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Java/">Java</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/deep-in-eureka/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/deep-in-eureka/thumbnail.jpg" alt="微服务注册中心 Eureka 架构深入解读（转载）">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-10-03T13:15:06.000Z">2019-10-03</time></div>
                    <a href="/deep-in-eureka/" class="has-link-black-ter is-size-6">微服务注册中心 Eureka 架构深入解读（转载）</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Spring-Cloud/">Spring Cloud</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/deep-in-synchronized/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/deep-in-synchronized/thumbnail.jpg" alt="【Java 并发】synchornized学习笔记">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-09-07T01:44:19.000Z">2019-09-07</time></div>
                    <a href="/deep-in-synchronized/" class="has-link-black-ter is-size-6">【Java 并发】synchornized学习笔记</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Java/">Java</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/paxos-made-simple/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/paxos-made-simple/thumbnail.jpg" alt="Paxos Made Simple(译文)">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-08-22T12:55:35.000Z">2019-08-22</time></div>
                    <a href="/paxos-made-simple/" class="has-link-black-ter is-size-6">Paxos Made Simple(译文)</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">十月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">九月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/08/">
                <span class="level-start">
                    <span class="level-item">八月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">七月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/05/">
                <span class="level-start">
                    <span class="level-item">五月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Algorithm/">
                        <span class="tag">Algorithm</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Binary-Tree/">
                        <span class="tag">Binary Tree</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Eureka/">
                        <span class="tag">Eureka</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Hexo-博客搭建/">
                        <span class="tag">Hexo 博客搭建</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JVM/">
                        <span class="tag">JVM</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Redis-持久化/">
                        <span class="tag">Redis 持久化</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring-IOC/">
                        <span class="tag">Spring IOC</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring-MVC/">
                        <span class="tag">Spring MVC</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/并发/">
                        <span class="tag">并发</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    Keanu
                
                </a>
                <p class="is-size-7">
                &copy; 2019 Keanu&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons,fab fa-creative-commons-by,fab fa-creative-commons-nc,fab fa-creative-commons-sa"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/keanu96">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>